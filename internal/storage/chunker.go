package storage

import (
	"bufio"
	"io"
)

const (
	minChunkSize = 32 * 1024  // 32KB
	avgChunkSize = 64 * 1024  // 64KB
	maxChunkSize = 512 * 1024 // 512KB
)

// Pre-calculated Gear table with high entropy
var gear = [256]uint64{
	0x973a1ed0e68d1847, 0x1f896b026d0d54a2, 0x0ef96c2134606797, 0x33e54b0fc95a4847,
	0x054f0a99696b0253, 0x1bce32598383e20d, 0x16b677051b853c8c, 0x0e8d0e7683955677,
	0x0f25c0fb11a51a1c, 0x06060c218204123d, 0x07f5979f45d1d668, 0x08e33f92de0d4c92,
	0x09ae54b6d0815617, 0x0a6d0c9e6d0d54a2, 0x0b8d42cb3a5d5c0e, 0x0c934b07e81244c3,
	0x0d3e56f0b1a51a1c, 0x0e060c218204123d, 0x17f5979f45d1d668, 0x18e33f92de0d4c92,
	0x19ae54b6d0815617, 0x0a6d0c9e6d0d54a2, 0x0b8d42cb3a5d5c0e, 0x1c934b07e81244c3,
	0x1d3e56f0b1a51a1c, 0x1e3a1ed0e68d1847, 0x1f896b026d0d54a2, 0x20f96c2134606797,
	0x21e54b0fc95a4847, 0x224f0a99696b0253, 0x23ce32598383e20d, 0x24b677051b853c8c,
	0x258d0e7683955677, 0x2625c0fb11a51a1c, 0x27060c218204123d, 0x28f5979f45d1d668,
	0x29e33f92de0d4c92, 0x2aae54b6d0815617, 0x2b6d0c9e6d0d54a2, 0x2c8d42cb3a5d5c0e,
	0x2d934b07e81244c3, 0x2e3e56f0b1a51a1c, 0x2f060c218204123d, 0x30f5979f45d1d668,
	0x31e33f92de0d4c92, 0x32ae54b6d0815617, 0x336d0c9e6d0d54a2, 0x348d42cb3a5d5c0e,
	0x35934b07e81244c3, 0x363e56f0b1a51a1c, 0x37060c218204123d, 0x38f5979f45d1d668,
	0x39e33f92de0d4c92, 0x3aae54b6d0815617, 0x3b6d0c9e6d0d54a2, 0x3c8d42cb3a5d5c0e,
	0x3d934b07e81244c3, 0x3e3e56f0b1a51a1c, 0x3f060c218204123d, 0x40f5979f45d1d668,
	0x41e33f92de0d4c92, 0x42ae54b6d0815617, 0x436d0c9e6d0d54a2, 0x448d42cb3a5d5c0e,
	0x45934b07e81244c3, 0x463e56f0b1a51a1c, 0x47060c218204123d, 0x48f5979f45d1d668,
	0x49e33f92de0d4c92, 0x4aae54b6d0815617, 0x4b6d0c9e6d0d54a2, 0x4c8d42cb3a5d5c0e,
	0x4d934b07e81244c3, 0x4e3e56f0b1a51a1c, 0x4f060c218204123d, 0x50f5979f45d1d668,
	0x51e33f92de0d4c92, 0x52ae54b6d0815617, 0x536d0c9e6d0d54a2, 0x548d42cb3a5d5c0e,
	0x55934b07e81244c3, 0x563e56f0b1a51a1c, 0x57060c218204123d, 0x58f5979f45d1d668,
	0x59e33f92de0d4c92, 0x5aae54b6d0815617, 0x5b6d0c9e6d0d54a2, 0x5c8d42cb3a5d5c0e,
	0x5d934b07e81244c3, 0x5e3e56f0b1a51a1c, 0x5f060c218204123d, 0x60f5979f45d1d668,
	0x61e33f92de0d4c92, 0x62ae54b6d0815617, 0x636d0c9e6d0d54a2, 0x648d42cb3a5d5c0e,
	0x65934b07e81244c3, 0x663e56f0b1a51a1c, 0x67060c218204123d, 0x68f5979f45d1d668,
	0x69e33f92de0d4c92, 0x6aae54b6d0815617, 0x6b6d0c9e6d0d54a2, 0x6c8d42cb3a5d5c0e,
	0x6d934b07e81244c3, 0x6e3e56f0b1a51a1c, 0x6f060c218204123d, 0x70f5979f45d1d668,
	0x71e33f92de0d4c92, 0x72ae54b6d0815617, 0x736d0c9e6d0d54a2, 0x748d42cb3a5d5c0e,
	0x75934b07e81244c3, 0x763e56f0b1a51a1c, 0x77060c218204123d, 0x78f5979f45d1d668,
	0x79e33f92de0d4c92, 0x7aae54b6d0815617, 0x7b6d0c9e6d0d54a2, 0x7c8d42cb3a5d5c0e,
	0x7d934b07e81244c3, 0x7e3e56f0b1a51a1c, 0x7f060c218204123d, 0x80f5979f45d1d668,
	0x81e33f92de0d4c92, 0x82ae54b6d0815617, 0x836d0c9e6d0d54a2, 0x848d42cb3a5d5c0e,
	0x85934b07e81244c3, 0x863e56f0b1a51a1c, 0x87060c218204123d, 0x88f5979f45d1d668,
	0x89e33f92de0d4c92, 0x8aae54b6d0815617, 0x8b6d0c9e6d0d54a2, 0x8c8d42cb3a5d5c0e,
	0x8d934b07e81244c3, 0x8e3e56f0b1a51a1c, 0x8f060c218204123d, 0x90f5979f45d1d668,
	0x91e33f92de0d4c92, 0x92ae54b6d0815617, 0x936d0c9e6d0d54a2, 0x948d42cb3a5d5c0e,
	0x95934b07e81244c3, 0x963e56f0b1a51a1c, 0x97060c218204123d, 0x98f5979f45d1d668,
	0x99e33f92de0d4c92, 0x9aae54b6d0815617, 0x9b6d0c9e6d0d54a2, 0x9c8d42cb3a5d5c0e,
	0x9d934b07e81244c3, 0x9e3e56f0b1a51a1c, 0x9f060c218204123d, 0xa0f5979f45d1d668,
	0xa1e33f92de0d4c92, 0xa2ae54b6d0815617, 0xa36d0c9e6d0d54a2, 0xa48d42cb3a5d5c0e,
	0xa5934b07e81244c3, 0xa63e56f0b1a51a1c, 0xa7060c218204123d, 0xa8f5979f45d1d668,
	0xa9e33f92de0d4c92, 0xaaae54b6d0815617, 0xab6d0c9e6d0d54a2, 0xac8d42cb3a5d5c0e,
	0xad934b07e81244c3, 0xae3e56f0b1a51a1c, 0xaf060c218204123d, 0xb0f5979f45d1d668,
	0xb1e33f92de0d4c92, 0xb2ae54b6d0815617, 0xb36d0c9e6d0d54a2, 0xb48d42cb3a5d5c0e,
	0xb5934b07e81244c3, 0xb63e56f0b1a51a1c, 0xb7060c218204123d, 0xb8f5979f45d1d668,
	0xb9e33f92de0d4c92, 0xbaae54b6d0815617, 0xbb6d0c9e6d0d54a2, 0xbc8d42cb3a5d5c0e,
	0xbd934b07e81244c3, 0xbe3e56f0b1a51a1c, 0xbf060c218204123d, 0xc0f5979f45d1d668,
	0xc1e33f92de0d4c92, 0xc2ae54b6d0815617, 0xc36d0c9e6d0d54a2, 0xc48d42cb3a5d5c0e,
	0xc5934b07e81244c3, 0xc63e56f0b1a51a1c, 0xc7060c218204123d, 0xc8f5979f45d1d668,
	0xc9e33f92de0d4c92, 0xcaae54b6d0815617, 0xcb6d0c9e6d0d54a2, 0xcc8d42cb3a5d5c0e,
	0xcd934b07e81244c3, 0xce3e56f0b1a51a1c, 0xcf060c218204123d, 0xd0f5979f45d1d668,
	0xd1e33f92de0d4c92, 0xd2ae54b6d0815617, 0xd36d0c9e6d0d54a2, 0xd48d42cb3a5d5c0e,
	0xd5934b07e81244c3, 0xd63e56f0b1a51a1c, 0xd7060c218204123d, 0xd8f5979f45d1d668,
	0xd9e33f92de0d4c92, 0xdaae54b6d0815617, 0xdb6d0c9e6d0d54a2, 0xdc8d42cb3a5d5c0e,
	0xdd934b07e81244c3, 0xde3e56f0b1a51a1c, 0xdf060c218204123d, 0xe0f5979f45d1d668,
	0xe1e33f92de0d4c92, 0xe2ae54b6d0815617, 0xe36d0c9e6d0d54a2, 0xe48d42cb3a5d5c0e,
	0xe5934b07e81244c3, 0xe63e56f0b1a51a1c, 0xe7060c218204123d, 0xe8f5979f45d1d668,
	0xe9e33f92de0d4c92, 0xeaae54b6d0815617, 0xeb6d0c9e6d0d54a2, 0xec8d42cb3a5d5c0e,
	0xed934b07e81244c3, 0xee3e56f0b1a51a1c, 0xef060c218204123d, 0xf0f5979f45d1d668,
	0xf1e33f92de0d4c92, 0xf2ae54b6d0815617, 0xf36d0c9e6d0d54a2, 0xf48d42cb3a5d5c0e,
	0xf5934b07e81244c3, 0xf63e56f0b1a51a1c, 0xf7060c218204123d, 0xf8f5979f45d1d668,
	0xf9e33f92de0d4c92, 0xfaae54b6d0815617, 0xfb6d0c9e6d0d54a2, 0xfc8d42cb3a5d5c0e,
	0xfd934b07e81244c3, 0xfe3e56f0b1a51a1c, 0xff060c218204123d,
}

// Chunker breaks a stream into content-defined chunks
type Chunker struct {
	r *bufio.Reader
}

func NewChunker(r io.Reader) *Chunker {
	return &Chunker{r: bufio.NewReader(r)}
}

// Next returns the next content-defined chunk.
func (c *Chunker) Next() ([]byte, error) {
	var buf []byte
	var hash uint64

	// 1. Read minimum chunk size
	for len(buf) < minChunkSize {
		b, err := c.r.ReadByte()
		if err != nil {
			if len(buf) > 0 {
				return buf, nil
			}
			return nil, err
		}
		buf = append(buf, b)
		hash = (hash << 1) ^ gear[b] // Added XOR
	}

	// 2. Scan for boundary using rolling hash
	// Mask for ~64KB average: 2^16 - 1
	mask := uint64(0x0FFFF)

	for len(buf) < maxChunkSize {
		b, err := c.r.ReadByte()
		if err != nil {
			return buf, nil
		}
		buf = append(buf, b)
		hash = (hash << 1) ^ gear[b] // Added XOR

		if (hash & mask) == 0 {
			break
		}
	}

	return buf, nil
}
